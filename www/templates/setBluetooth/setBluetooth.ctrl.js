angular.module('app').controller('setBluetoothController', ['$rootScope', '$scope', 'utils', function ($rootScope, $scope, utils) {
    $scope.isEnabled = false;
    $scope.DeviceName = '';
    $scope.Devices = [];

    $rootScope.Bluetooth={};


    //蓝牙是否打开
    $scope.Open = function () {
        utils.$cordovaBluetoothSerial.isEnabled(function () {
            $scope.isEnabled = true;
            $scope.Scan();
        }, function () {
            $scope.isEnabled = false;
        });
    }

    //扫描已配对的蓝牙设备
    $scope.Scan = function () {
        utils.$cordovaBluetoothSerial.list().then(function (devices) {
            $scope.Devices = devices;
        }, function (error) {

        })
    }

    $scope.isConnected = function () {
        utils.$cordovaBluetoothSerial.isConnected().then(function (obj) {
            console.log(obj);
            $scope.DeviceName = $rootScope.Bluetooth.name+'：'+$rootScope.Bluetooth.id;
        }, function (error) {

        });
    }

    //连接蓝牙设备
    $scope.connectDevice = function (device) {
        utils.$cordovaBluetoothSerial.connect(device.id).then(function () {
                $scope.DeviceName=device.name+'：'+device.id;
                $rootScope.Bluetooth.id=device.id;
                $rootScope.Bluetooth.name=device.name;
            },
            function (error) {
                console.log(error);
            })

    }
    //打开系统蓝牙设置页面
    $scope.ShowBluetoothSettings = function () {
        utils.$cordovaBluetoothSerial.showBluetoothSettings(function(obj){
            console.log(obj);
        }, function(error){
            console.log(error);
        });
    }

    //打开蓝牙
    $scope.btnOpenOrClose_Click = function () {
        if ($scope.isEnabled) {
            utils.$cordovaBluetoothSerial.enable().then(function (obj) {
                console.log(obj);
            }, function (obj) {
                console.log(obj);
            });
        } else {
            $scope.ShowBluetoothSettings();
        }
    }

    $scope.TestPrinter=function(){
        var data="0x1b 0x40 0x1b 0x4c 0x1b 0x57 0x00 0x00 0x00 0x00 0x30 0x02 0x00 0x01  0x1b 0x24 0x50 0x00  0x1d 0x24 0x20 0x00 0x42 0x4f 0x5a 0x48 0x4f 0x4e 0x20 0xb2 0xa9 0xd6 0xda 0x20 0x43 0x4d 0x41 0x53 0x2d 0x57 0x4d 0x53 0x1b 0x24 0x40 0x00  0x1d 0x24 0x40 0x00 0xc5 0xfa 0xba 0xc5 0xa3 0xba 0x57 0x31 0x36 0x30 0x31 0x33 0x32 0x30 0x30 0x33 0x38 0x34 0x0a 0x1b 0x24 0xb0 0x01 0x1d 0x24 0x80 0x00 0x1d 0x6f 0x00 0x04 0x00 0x02 0x1d 0x6b 0x4b 0x24 0x31 0x32 0x2c 0x2c 0x33 0x31 0x31 0x30 0x39 0x31 0x34 0x31 0x32 0x30 0x30 0x37 0x32 0x2c 0x31 0x30 0x30 0x2c 0x57 0x31 0x36 0x30 0x31 0x33 0x32 0x30 0x30 0x33 0x38 0x34 0x2d 0x0a 0x1b 0x24 0x40 0x00 0x1d 0x24 0x60 0x00 0xc1 0xcf 0xba 0xc5 0xa3 0xba 0x33 0x31 0x31 0x30 0x39 0x31 0x34 0x31 0x32 0x30 0x30 0x37 0x32 0x20 0xca 0xfd 0xc1 0xbf 0x3a 0x31 0x30 0x30 0x0a 0x1b 0x24 0x40 0x00 0x1d 0x24 0x80 0x00 0xc4 0xb8 0xb9 0xa4 0xb5 0xa5 0xa3 0xba 0x0a 0x1b 0x24 0x40 0x00  0x1d 0x24 0xa0 0x00 0xc6 0xb7 0xc3 0xfb 0xa3 0xba 0xcc 0xf9 0xc6 0xac 0xb5 0xe7 0xd7 0xe8 0x0a 0x1b 0x24 0x40 0x00  0x1d 0x24 0xc0 0x00 0x1b 0x21 0x01 0xb9 0xe6 0xb8 0xf1 0xa3 0xba 0x30 0x38 0x30 0x35 0x20 0x31 0x30 0x30 0xa6 0xb8 0x20 0x31 0x2f 0x38 0x57 0x20 0x31 0x25 0x3b 0x3b 0xba 0xf1 0xc9 0xf9 0x3b 0x0a 0x0c"
        utils.$cordovaBluetoothSerial.write(data.split(' ')).then(function(){
            var alertPopup = $ionicPopup.alert({
                title: '提示!',
                template: "数据发送成功！"
            });
        },function(error){
            var alertPopup = $ionicPopup.alert({
                title: '提示!',
                template: "列印失败，"+error
            });
        });
    }
}]);